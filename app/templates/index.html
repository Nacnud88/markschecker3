<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marks Checker 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon/peach.svg') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon/apple-touch-icon.png') }}">
    <style>
        :root {
            --primary-green: #00483b;
            --accent-cyan: #00d9f9;
            --bg-light: #f5f7f9;
            --text-dark: #002f2c;
        }
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: var(--primary-green);
        }
        .navbar-brand {
            font-weight: 700;
            color: var(--accent-cyan) !important;
        }
        .card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 18px 45px rgba(0, 50, 50, 0.08);
        }
        .product-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 32px rgba(0, 0, 0, 0.12);
        }
        .not-found-card {
            background-color: #ffe6e6;
            border-left: 5px solid #dc3545;
        }
        .not-found-icon {
            font-size: 3rem;
            color: #dc3545;
        }
        .progress {
            height: 0.9rem;
        }
        .badge-region {
            background-color: rgba(0, 217, 249, 0.15);
            color: var(--primary-green);
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fa-solid fa-basket-shopping me-2"></i>Marks Checker 3
            </a>
        </div>
    </nav>

    <main class="container pb-5">
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Start a Search</h5>
                        <div class="mb-3">
                            <label class="form-label">Voila global_sid cookie</label>
                            <input type="password" class="form-control" id="globalSidInput" placeholder="Paste your global_sid" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Article or Product Codes</label>
                            <textarea class="form-control" id="termsInput" rows="8" placeholder="One code per line"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">Search Type</label>
                                <select class="form-select" id="searchType">
                                    <option value="article" selected>Article</option>
                                    <option value="product">Product</option>
                                </select>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">Result Limit</label>
                                <input type="text" id="limitInput" class="form-control" value="all" />
                            </div>
                        </div>
                        <button id="startSearchBtn" class="btn btn-success w-100">
                            <i class="fa-solid fa-play me-1"></i>Start Search
                        </button>
                        <button id="cancelBtn" class="btn btn-outline-secondary w-100 mt-2" disabled>
                            Cancel
                        </button>
                        <div id="progressWrapper" class="mt-4 d-none">
                            <div class="d-flex justify-content-between">
                                <span id="progressLabel">Waiting…</span>
                                <span id="progressCount"></span>
                            </div>
                            <div class="progress mt-2">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mt-4" id="regionBadge"></div>
                        <div class="mt-3 text-muted small">
                            <strong>Tip:</strong> keep the tab open while the search runs. Chunk size is optimised automatically.
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Results</h5>
                        <div id="statsSummary" class="mb-3 text-muted"></div>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button class="btn btn-sm btn-outline-primary" data-filter="all">All</button>
                            <button class="btn btn-sm btn-outline-success" data-filter="found">Found</button>
                            <button class="btn btn-sm btn-outline-danger" data-filter="missing">Not Found</button>
                            <button id="exportBtn" class="btn btn-sm btn-outline-secondary ms-auto">
                                <i class="fa-solid fa-file-export me-1"></i>Export CSV
                            </button>
                        </div>
                        <div id="resultsContainer" class="row g-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <template id="productTemplate">
        <div class="col-md-6 col-xl-4 result-card">
            <div class="card product-card h-100">
                <img class="card-img-top product-image" alt="Product image" />
                <div class="card-body">
                    <h6 class="product-name"></h6>
                    <div class="text-muted small product-brand"></div>
                    <div class="mt-2">
                        <span class="fw-bold product-price"></span>
                        <span class="text-muted text-decoration-line-through product-original-price"></span>
                    </div>
                    <div class="small text-muted product-unit"></div>
                </div>
                <div class="card-footer bg-transparent border-0">
                    <small class="text-muted product-meta"></small>
                </div>
            </div>
        </div>
    </template>

    <template id="missingTemplate">
        <div class="col-md-6 col-xl-4 result-card">
            <div class="card not-found-card h-100">
                <div class="card-body text-center">
                    <i class="fas fa-triangle-exclamation not-found-icon mb-3"></i>
                    <h6 class="fw-bold">Article not found</h6>
                    <p class="text-muted small missing-reason"></p>
                </div>
                <div class="card-footer bg-transparent border-0 text-center">
                    <span class="badge bg-secondary missing-term"></span>
                </div>
            </div>
        </div>
    </template>

    <script>
        const state = {
            sessionId: null,
            chunkSize: 0,
            totalChunks: 0,
            processedChunks: 0,
            totalTerms: 0,
            processedTerms: 0,
            terms: [],
            limit: "all",
            searchType: "article",
            globalSid: "",
            cancel: false,
            products: [],
            totals: { found: 0, missing: 0 }
        };

        const startBtn = document.getElementById("startSearchBtn");
        const cancelBtn = document.getElementById("cancelBtn");
        const resultsContainer = document.getElementById("resultsContainer");
        const progressWrapper = document.getElementById("progressWrapper");
        const progressBar = document.getElementById("progressBar");
        const progressLabel = document.getElementById("progressLabel");
        const progressCount = document.getElementById("progressCount");
        const statsSummary = document.getElementById("statsSummary");
        const exportBtn = document.getElementById("exportBtn");
        const regionBadge = document.getElementById("regionBadge");

        document.querySelectorAll("[data-filter]").forEach((btn) => {
            btn.addEventListener("click", () => applyFilter(btn.dataset.filter));
        });

        exportBtn.addEventListener("click", exportCsv);

        startBtn.addEventListener("click", async () => {
            if (state.processing) return;
            resetState();

            state.globalSid = document.getElementById("globalSidInput").value.trim();
            const termsInput = document.getElementById("termsInput").value;
            state.searchType = document.getElementById("searchType").value;
            state.limit = document.getElementById("limitInput").value || "all";

            if (!state.globalSid) {
                alert("Please provide your global_sid cookie value.");
                return;
            }
            if (!termsInput.trim()) {
                alert("Enter at least one search term.");
                return;
            }

            startBtn.disabled = true;
            cancelBtn.disabled = false;
            state.processing = true;
            progressWrapper.classList.remove("d-none");

            try {
                await startSession(termsInput);
                await runChunks();
                await loadResults();
            } catch (error) {
                console.error(error);
                alert(error.message || "Search failed. Check console for details.");
            } finally {
                state.processing = false;
                startBtn.disabled = false;
                cancelBtn.disabled = true;
            }
        });

        cancelBtn.addEventListener("click", () => {
            state.cancel = true;
            progressLabel.textContent = "Cancelling…";
            cancelBtn.disabled = true;
        });

        async function startSession(rawTerms) {
            const response = await fetch("/api/sessions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    globalSid: state.globalSid,
                    searchTerm: rawTerms,
                    searchType: state.searchType,
                    limit: state.limit
                })
            });
            if (!response.ok) {
                throw new Error(`Failed to start session (${response.status})`);
            }
            const data = await response.json();
            state.sessionId = data.sessionId;
            state.chunkSize = data.chunkSize;
            state.totalChunks = data.totalChunks;
            state.terms = data.terms;
            state.totalTerms = data.totalTerms;
            state.limit = data.limit;
            updateRegionBadge(data.region);
        }

        async function runChunks() {
            const chunkSize = state.chunkSize || 400;
            for (let index = 0; index < state.totalChunks; index += 1) {
                if (state.cancel) break;

                const start = index * chunkSize;
                const end = Math.min(start + chunkSize, state.terms.length);
                const terms = state.terms.slice(start, end);

                updateProgress(index + 1, terms.length);

                const response = await fetch(`/api/sessions/${state.sessionId}/chunks`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        chunkIndex: index,
                        terms,
                        globalSid: state.globalSid,
                        searchType: state.searchType,
                        limit: state.limit
                    })
                });

                if (!response.ok) {
                    throw new Error(`Chunk ${index + 1} failed (${response.status})`);
                }
            }
        }

        async function loadResults() {
            const response = await fetch(`/api/sessions/${state.sessionId}/results`);
            if (!response.ok) {
                throw new Error("Failed to load results");
            }
            const data = await response.json();
            state.products = data.products || [];
            renderResults();
        }

        function updateProgress(chunkNumber, termsProcessed) {
            state.processedChunks = chunkNumber;
            state.processedTerms += termsProcessed;
            const percent = Math.min(100, Math.round((state.processedTerms / state.totalTerms) * 100));
            progressBar.style.width = `${percent}%`;
            progressLabel.textContent = `Processing chunk ${chunkNumber} of ${state.totalChunks}`;
            progressCount.textContent = `${state.processedTerms}/${state.totalTerms} terms`;
        }

        function renderResults(filter = "all") {
            resultsContainer.innerHTML = "";
            state.totals = { found: 0, missing: 0 };

            const productTemplate = document.getElementById("productTemplate");
            const missingTemplate = document.getElementById("missingTemplate");

            for (const product of state.products) {
                const isFound = product.found !== false;
                if (filter === "found" && !isFound) continue;
                if (filter === "missing" && isFound) continue;

                const clone = (isFound ? productTemplate : missingTemplate).content.cloneNode(true);

                if (isFound) {
                    state.totals.found += 1;
                    const image = clone.querySelector(".product-image");
                    image.src = product.imageUrl || "https://via.placeholder.com/256?text=No+Image";
                    image.alt = product.name || "Product image";

                    clone.querySelector(".product-name").textContent = product.name || "Unnamed product";
                    clone.querySelector(".product-brand").textContent = product.brand || "Unknown brand";

                    const priceEl = clone.querySelector(".product-price");
                    if (product.currentPrice != null) {
                        priceEl.textContent = `$${product.currentPrice}`;
                    } else {
                        priceEl.textContent = "Price unavailable";
                    }

                    const originalEl = clone.querySelector(".product-original-price");
                    if (product.originalPrice && product.originalPrice > product.currentPrice) {
                        originalEl.textContent = `$${product.originalPrice}`;
                    } else {
                        originalEl.textContent = "";
                    }

                    const metaFields = [];
                    if (product.productId) metaFields.push(product.productId);
                    if (product.retailerProductId && product.retailerProductId !== product.productId) {
                        metaFields.push(product.retailerProductId);
                    }
                    metaFields.push(product.searchTerm);

                    const unitEl = clone.querySelector(".product-unit");
                    if (product.unitPrice && product.unitLabel) {
                        const unitLabel = product.unitLabel.replace('fop.price.per.', '').replace(/\./g, ' ');
                        unitEl.textContent = `Unit price: $${product.unitPrice} per ${unitLabel}`;
                        metaFields.push(`Unit: $${product.unitPrice} / ${unitLabel}`);
                    } else {
                        unitEl.textContent = "";
                    }

                    if (product.currency) {
                        metaFields.push(`Currency: ${product.currency}`);
                    }

                    if (Array.isArray(product.category) && product.category.length) {
                        metaFields.push(product.category.join(" > "));
                    }

                    if (Array.isArray(product.offers) && product.offers.length) {
                        const offerDescriptions = product.offers
                            .map((offer) => offer.description || offer.longDescription)
                            .filter(Boolean);
                        if (offerDescriptions.length) {
                            metaFields.push(`Offers: ${offerDescriptions.join("; ")}`);
                        }
                    }

                    clone.querySelector(".product-meta").textContent = metaFields.filter(Boolean).join(" • ");
                } else {
                    state.totals.missing += 1;
                    clone.querySelector(".missing-reason").textContent = product.notFoundMessage || "No additional information.";
                    clone.querySelector(".missing-term").textContent = product.searchTerm;
                }

                resultsContainer.appendChild(clone);
            }

            statsSummary.innerHTML = `
                Found: <strong>${state.totals.found}</strong> |
                Missing: <strong>${state.totals.missing}</strong> |
                Total: <strong>${state.products.length}</strong>
            `;
        }

        function applyFilter(filter) {
            renderResults(filter);
        }

        function resetState() {
            state.sessionId = null;
            state.chunkSize = 0;
            state.totalChunks = 0;
            state.processedChunks = 0;
            state.totalTerms = 0;
            state.processedTerms = 0;
            state.terms = [];
            state.products = [];
            state.totals = { found: 0, missing: 0 };
            state.cancel = false;
            resultsContainer.innerHTML = "";
            statsSummary.textContent = "";
            progressBar.style.width = "0%";
            progressLabel.textContent = "Initialising…";
            progressCount.textContent = "";
            regionBadge.innerHTML = "";
        }

        function exportCsv() {
            if (!state.products.length) {
                alert("No results to export yet.");
                return;
            }
            const rows = [
                ["Search Term", "Name", "Brand", "Current Price", "Original Price", "Unit Price", "Unit Label", "Product ID", "Retailer ID", "Found"]
            ];

            for (const product of state.products) {
                rows.push([
                    product.searchTerm || "",
                    product.name || "",
                    product.brand || "",
                    product.currentPrice || "",
                    product.originalPrice || "",
                    product.unitPrice || "",
                    product.unitLabel || "",
                    product.productId || "",
                    product.retailerProductId || "",
                    product.found !== false ? "yes" : "no"
                ]);
            }

            const csv = rows.map((columns) =>
                columns.map((value) => `"${String(value).replace(/"/g, '""')}"`).join(",")
            ).join("\n");

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `markschecker-results-${Date.now()}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function updateRegionBadge(region) {
            if (!region) {
                regionBadge.innerHTML = "";
                return;
            }
            const nickname = region.nickname || "Unknown Region";
            const address = region.displayAddress || "";

            regionBadge.innerHTML = `
                <div class="alert alert-light border">
                    <span class="badge badge-region me-2"><i class="fa-solid fa-location-dot me-1"></i>${nickname}</span>
                    ${address}
                </div>
            `;
        }
    </script>
</body>
</html>
